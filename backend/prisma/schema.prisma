generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Property {
  id         String     @id @default(cuid())
  name       String
  location   String
  priceRange String?
  config     String?
  builder    String?
  reraId     String?
  usps       Json?
  links      Json?
  campaigns  Campaign[]
}

model Campaign {
  id                      String                   @id @default(cuid())
  name                    String
  userId                  String
  propertyId              String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  callerDisplayName       String?
  callerIdentityMode      String?                  @default("GENERIC")
  campaignKnowledge       Json?
  knowledgeUsageMode      String?                  @default("INTERNAL_ONLY")
  voiceKnowledge          Json?
  voiceTranscript         String?
  voiceTranscriptLanguage String?
  batchJobs               BatchCallJob[]
  property                Property?                @relation(fields: [propertyId], references: [id])
  campaignContacts        CampaignContact[]
  outcomePatterns         OutcomeLearningPattern[]
}

model Contact {
  id        String            @id @default(cuid())
  userId    String
  name      String
  phone     String
  email     String?
  tags      Json?
  source    String?
  createdAt DateTime          @default(now())
  campaigns CampaignContact[]
}

model CampaignContact {
  id                    String              @id @default(cuid())
  campaignId            String
  contactId             String
  status                LeadStatus          @default(NOT_PICK)
  lastCallAt            DateTime?
  convertedAt           DateTime?
  followUpAfterHours    Int?
  followUpChannel       String?
  followUpMessageIntent String?
  followUpPlannedAt     DateTime?
  handoffReason         String?
  handoffRecommended    Boolean             @default(false)
  isConverted           Boolean             @default(false)
  lastQuestionsAsked    String[]            @default([])
  objections            String[]            @default([])
  preferredLanguage     String?
  sentimentTrend        String[]            @default([])
  extraContext          Json?
  learningPatterns      AILearningPattern[]
  calls                 CallLog[]
  campaign              Campaign            @relation(fields: [campaignId], references: [id])
  contact               Contact             @relation(fields: [contactId], references: [id])
}

model CallLog {
  id                       String              @id @default(cuid())
  campaignContactId        String
  startedAt                DateTime            @default(now())
  endedAt                  DateTime?
  durationSeconds          Int?
  transcript               String?
  aiSummary                String?
  aiExplicitInterest       Boolean?
  aiEngagementLevel        String?
  aiNextStepBooked         Boolean?
  resultStatus             LeadStatus?
  twilioCallSid            String?
  postCallBestCallbackTime String?
  postCallInterestLevel    String?
  postCallNextAction       String?
  postCallObjections       String[]            @default([])
  postCallSummary          String[]            @default([])
  emotion                  String?
  urgencyLevel             String?
  urgencyReason            String?
  scriptMode               String?
  objectionStrategy        String?
  outcomeAction            String?
  outcomeBucket            String?
  outcomeConfidence        String?
  outcomeFollowUp          String?
  outcomeProbability       Int?
  language                 String?
  scriptVariant            String?
  speechRate               String?
  voiceTone                String?
  learningPatterns         AILearningPattern[]
  campaignContact          CampaignContact     @relation(fields: [campaignContactId], references: [id])
}

/// *
///  * AI Learning Pattern model for storing successful call patterns.
///  * This table captures patterns from converted leads for future ML model training.
///  * TODO: Future ML Implementation
///  * - Use this data to train models that predict successful conversation patterns
///  * - Build recommendation system for objection handling based on successful resolutions
///  * - Create embeddings for transcript patterns and objection-resolution sequences
///  * - Implement reinforcement learning to optimize AI responses
model AILearningPattern {
  id                          String          @id @default(cuid())
  campaignContactId           String
  callLogId                   String?
  transcriptPattern           Json?
  objectionResolutionSequence Json?
  conversationFlow            Json?
  initialStatus               LeadStatus?
  finalStatus                 LeadStatus?
  questionsAsked              String[]        @default([])
  objectionsRaised            String[]        @default([])
  sentimentProgression        String[]        @default([])
  createdAt                   DateTime        @default(now())
  conversionDate              DateTime?
  callLog                     CallLog?        @relation(fields: [callLogId], references: [id])
  campaignContact             CampaignContact @relation(fields: [campaignContactId], references: [id])
}

model BatchCallJob {
  id            String    @id @default(cuid())
  campaignId    String
  status        String
  currentIndex  Int       @default(0)
  totalLeads    Int
  cooldownHours Int
  maxRetries    Int
  startedAt     DateTime?
  pausedAt      DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?
  cancelledBy   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  campaign      Campaign  @relation(fields: [campaignId], references: [id])
}

model OutcomeLearningPattern {
  id            String   @id @default(cuid())
  campaignId    String
  scriptVariant String?
  voiceTone     String?
  emotion       String?
  urgencyLevel  String?
  objections    String[] @default([])
  outcomeBucket String?
  converted     Boolean  @default(false)
  createdAt     DateTime @default(now())
  campaign      Campaign @relation(fields: [campaignId], references: [id])
}

enum LeadStatus {
  NOT_PICK
  COLD
  WARM
  HOT
}
